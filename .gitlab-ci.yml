stages:
  - setup
  - version_check
  - test_core
  - test_gui
  - unittest_core
  - docs

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: latest

default:
  image: $IMAGE_NAME:$IMAGE_TAG

# -----------------------
# 1️⃣ Setup (install repo once)
# -----------------------
setup:
  stage: setup
  script:
    - pip install -e .
  artifacts:
    paths:
      - $CI_PROJECT_DIR
    expire_in: 1h

# -----------------------
# 2️⃣ Version check
# -----------------------
version_check:
  stage: version_check
  needs:
    - job: setup
      artifacts: true
  script:
    - pip install toml
    - python CI/check_version.py
  rules:
    - changes:
        - Dockerfile
        - "**/*.toml"
        - "**/*.lock"
        - .gitlab-ci.yml
      when: always

# -----------------------
# 3️⃣ Core tests
# -----------------------
test_core:
  stage: test_core
  needs:
    - job: version_check
      artifacts: true
  script:
    - python CI/tests.py

# -----------------------
# 4️⃣ GUI tests
# -----------------------
test_gui:
  stage: test_gui
  needs:
    - job: version_check
      artifacts: true
  script:
    - export QT_DEBUG_PLUGINS=1
    - export QT_QPA_PLATFORM="offscreen"
    - python -c "from PyQt5 import QtWidgets; app = QtWidgets.QApplication([]); print('PyQt initialization successful')"
    - |
      set +e
      python -m unittest discover opentps_gui/opentps/gui
      code=$?
      set -e
      [ $code -eq 0 ] || [ $code -eq 5 ]

# -----------------------
# 5️⃣ Unit tests core
# -----------------------
unittest_core:
  stage: unittest_core
  needs:
    - job: version_check
      artifacts: true
  script:
    - cd $CI_PROJECT_DIR/opentps_core
    - touch opentps/__init__.py __init__.py
    - python -m unittest discover -s ./opentps -p '[!example]*.py' -v

# -----------------------
# 6️⃣ Documentation
# -----------------------
docs:
  stage: docs
  needs:
    - job: version_check
      artifacts: true
  script:
    - pip install sphinx sphinx-rtd-theme
    - cd docs
    - make html
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH