# Use specific image.  Slim or bullseye will still need a lot of GUI packages, so this is simpler
image: python:3.12

variables:
  POETRY_VERSION: "2.1.1"
  POETRY_HOME: "/opt/poetry"
  POETRY_CACHE_DIR: "$CI_PROJECT_DIR/.cache/poetry"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR/opentps_core:$CI_PROJECT_DIR/opentps_gui"

stages:
  - build
  - test_core
  - test_gui
  - unittest_core
  - doc

# Define the default cache configuration
cache:
  key:
    files:
      - opentps_core/poetry.lock
      - opentps_gui/poetry.lock
  paths:
    - .cache/poetry
    - .cache/pip
    - venv/
    - $POETRY_HOME
  policy: pull-push

# Shared setup logic for all jobs
.setup_script: &setup_script
  # Install basic requirements and debug info
  - python --version
  - apt-get update && apt-get install -y libgl1 virtualenv libglib2.0-0  # Install system dependencies

  # Set up Poetry (from cache if available)
  - if [ ! -d "$POETRY_HOME" ] || [ ! -f "$POETRY_HOME/bin/poetry" ]; then
      echo "Installing Poetry..." &&
      virtualenv $POETRY_HOME &&
      $POETRY_HOME/bin/pip install poetry==$POETRY_VERSION;
    else
      echo "Using cached Poetry installation";
    fi
  - source $POETRY_HOME/bin/activate
  - $POETRY_HOME/bin/poetry --version

  # Set up project virtualenv (from cache if available)
  - if [ ! -d "venv" ]; then
      echo "Creating virtual environment..." &&
      virtualenv -p python3.12 venv;
    else
      echo "Using cached virtual environment";
    fi
  - source venv/bin/activate

  # Install core dependencies
  - cd $CI_PROJECT_DIR/opentps_core
  - $POETRY_HOME/bin/poetry config virtualenvs.in-project true
  - $POETRY_HOME/bin/poetry install --no-root

  # Install GUI dependencies
  - cd $CI_PROJECT_DIR/opentps_gui
  - $POETRY_HOME/bin/poetry config virtualenvs.in-project true
  - $POETRY_HOME/bin/poetry install --no-root

  # Return to project root
  - cd $CI_PROJECT_DIR

build:
  image: python:3.12
  stage: build
  before_script:
    - *setup_script
  script:
    - cd $CI_PROJECT_DIR/opentps_core
    - $POETRY_HOME/bin/poetry build
    - cd $CI_PROJECT_DIR/opentps_gui
    - $POETRY_HOME/bin/poetry build
  artifacts:
    paths:
      - opentps_core/dist/*.whl
      - opentps_gui/dist/*.whl
    expire_in: 1 week

test_core:
  image: python:3.12
  stage: test_core
  before_script:
    - *setup_script
  script:
    - pip show SimpleITK  # For debugging
    - python3 CI/tests.py

test_gui:
  image: python:3.12
  stage: test_gui
  before_script:
    - *setup_script
  script:
    - pip show SimpleITK  # For debugging
    - pip show vtk  # For debugging
    - export QT_QPA_PLATFORM=offscreen
    - python -m unittest discover opentps_gui/opentps/gui || ( [ $? -eq 1 ] && echo "⚠️ No tests found, ignoring" && exit 0 )


docs:
  image: python:3.12
  stage: doc
  before_script:
    - *setup_script
    - pip install sphinx sphinx-rtd-theme
  script:
    - echo "Documentation build would go here"
    #- python3 docs/tools/version_utils.py
    #- cd docs
    #- make html
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Must be run after all script because we create __init__.py for unittest
unittest_core:
  stage: unittest_core
  image: python:3.12
  before_script:
    - *setup_script
  script:
    - cd $CI_PROJECT_DIR/opentps_core/
    - touch opentps/__init__.py  # because unittests does not work on namespace package
    - touch __init__.py  # because unittests does not work on namespace package
    - python3 -m unittest discover -s ./opentps -p '[!example]*.py' -v
